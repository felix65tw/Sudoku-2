<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êï∏Áç®ÈÅäÊà≤</title>
    <style>
        /* CSSËÆäÊï∏ÂÆöÁæ© - ‰∫ÆËâ≤‰∏ªÈ°å */
        :root {
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --text-secondary: #7f8c8d;
            --primary: #3498db;
            --primary-light: #5dade2;
            --success: #2ecc71;
            --success-light: #58d68d;
            --danger: #e74c3c;
            --warning: #f39c12;
            --highlight: #e8f4fd;
            --border: #bdc3c7;
            --shadow: rgba(0, 0, 0, 0.1);
            --disabled: #95a5a6;
        }

        /* CSSËÆäÊï∏ÂÆöÁæ© - ÊöóËâ≤‰∏ªÈ°å */
        .dark-theme {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #e6e6e6;
            --text-secondary: #b0b0b0;
            --primary: #3498db;
            --primary-light: #5dade2;
            --success: #2ecc71;
            --success-light: #58d68d;
            --danger: #e74c3c;
            --warning: #f39c12;
            --highlight: #2c3e50;
            --border: #4a5568;
            --shadow: rgba(0, 0, 0, 0.3);
            --disabled: #7f8c8d;
        }

        * {
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .game-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow: hidden;
        }

        .controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 0;
            margin-bottom: 0;
        }

        .btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 0;
            text-align: center;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background-color: var(--primary);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border);
        }

        .btn-on {
            background-color: var(--success);
            color: white;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:active {
            transform: scale(0.95);
            background-color: rgba(0, 0, 0, 0.1);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            padding: 0;
            margin: 0;
            line-height: 0.5;
            margin-top: 0;
        }

        .timer-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timer {
            font-weight: 700;
            font-family: monospace;
            color: var(--primary);
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }

        .timer:active {
            transform: scale(0.95);
        }

        .pause-btn {
            font-size: 0.7rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 5px;
            height: 5px;
        }

        .pause-btn:hover {
            color: var(--primary);
        }

        .stats {
            display: flex;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-icon {
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon.error {
            color: var(--danger);
        }

        .stat-icon.hint {
            color: var(--warning);
        }

        .stat-value {
            font-weight: 700;
            font-family: monospace;
            min-width: 20px;
            text-align: center;
            color: var(--text-color);
        }

        #sudoku-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 100%;
            aspect-ratio: 1;
            background-color: var(--border);
            border: 2px solid var(--border);
            gap: 1px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 4px 8px var(--shadow);
            transition: filter 0.3s ease;
        }

        #sudoku-board.blurred {
            filter: blur(4px);
            pointer-events: none;
        }

        .cell {
            background-color: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
        }

        .cell.clue, .cell.filled {
            color: var(--primary);
            font-weight: 700;
        }

        .cell.border-right { border-right: 2px solid var(--border); }
        .cell.border-bottom { border-bottom: 2px solid var(--border); }
        .cell.highlight-related { background-color: var(--highlight); }
        .cell.selected { background-color: rgba(52, 152, 219, 0.2) !important; }
        .cell.highlight-same { background-color: rgba(52, 152, 219, 0.3) !important; }
        .cell.error { color: var(--danger); }

        .notes-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            pointer-events: none;
            padding: 1px;
        }

        .note-num {
            font-size: 0.7rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            font-weight: 500;
        }

        .note-num.highlighted {
            background-color: var(--primary-light);
            color: white;
            border-radius: 2px;
            font-weight: 600;
        }

        .keypad {
            display: flex;
            gap: 6px;
            width: 100%;
            height: 50px;
        }

        .numpad-btn {
            flex: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .numpad-btn:active {
            transform: scale(0.95);
        }

        .numpad-btn .num {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .numpad-btn .count {
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-top: 1px;
            line-height: 1;
        }

        .numpad-btn.faded {
            opacity: 0.4;
        }

        .numpad-btn.suggested {
            border: 2px solid var(--warning);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(243, 156, 18, 0); }
            100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 90%;
            width: 320px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .pause-modal {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #5a67d8;
            border: none;
        }

        .pause-modal h2 {
            margin-top: 0;
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: #4c51bf;
        }

        .pause-modal p {
            color: #5a67d8;
            margin-bottom: 20px;
            font-size: 1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .pause-modal .modal-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #66a6ff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px 20px;
            width: 100%;
            font-weight: 600;
        }

        .pause-modal .modal-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .pause-modal .modal-btn:active {
            transform: translateY(0);
        }

        .bible-modal {
            background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%);
            color: #5d4037;
            border: 2px solid #8d6e63;
            overflow-y: visible;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
        }

        .bible-modal h2 {
            margin-top: 0;
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #5d4037;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-bottom: 2px solid #8d6e63;
            padding-bottom: 10px;
        }

        .bible-content {
            text-align: left;
            line-height: 1.8;
            font-size: 1.1rem;
            color: #4e342e;
            overflow-y: visible;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .bible-verse {
            margin-bottom: 15px;
            padding: 8px 0;
            border-bottom: 1px dashed #d7ccc8;
            padding-left: 2.5em;
            text-indent: -2.5em;
        }

        .bible-verse:last-child {
            border-bottom: none;
        }

        .verse-number {
            font-weight: bold;
            color: #8d6e63;
            margin-right: 8px;
            display: inline-block;
            width: 2.5em;
            text-align: right;
        }

        .bible-modal .modal-btn {
            background: #8d6e63;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            padding: 12px 24px;
            width: 100%;
            font-weight: 600;
            margin-top: 10px;
        }

        .bible-modal .modal-btn:hover {
            background: #6d4c41;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }

        .cell.error .main-num {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes text-flash {
            0%, 100% { color: var(--primary); transform: scale(1); }
            50% { color: #f39c12; transform: scale(1.2); }
        }

        .cell.hinting .main-num {
            animation: text-flash 0.6s ease-in-out 3;
        }

        .difficulty-select {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 6px 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            color: var(--text-color);
            font-weight: 600;
            min-width: 100px;
            text-align: center;
            text-align-last: center;
        }

        .difficulty-select:active {
            transform: scale(0.95);
            background-color: rgba(0, 0, 0, 0.05);
        }

        .difficulty-select option {
            text-align: center;
            font-weight: 600;
        }

        #fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: visible;
        }

        .firework-particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
        }

        /* ========== Êñ∞ÁöÑÂãùÂà©Áï´Èù¢Ê®£Âºè - ‰øùÁïôÂéüÊúâÈÅäÊà≤ÂäüËÉΩ ========== */
        .victory-modal {
            background: #ffffff; /* Á¥îÁôΩËâ≤ËÉåÊôØ */
            border: 3px solid #3498db;
            color: #2c3e50;
            animation: victory-neon-border 2s infinite alternate;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            z-index: 10001;
            min-width: 300px;
            max-width: 90%;
            text-align: center;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        /* ÈúìËôπÁáàÈÇäÊ°ÜÂãïÁï´ - ÂæûVictor.htmlÁßªÊ§ç‰ΩÜÁ∞°Âåñ */
        @keyframes victory-neon-border {
            0% {
                box-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 30px #ff00ff;
                border-color: #ff00ff;
            }
            25% {
                box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 0 0 30px #00ffff;
                border-color: #00ffff;
            }
            50% {
                box-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00, 0 0 30px #ffff00;
                border-color: #ffff00;
            }
            75% {
                box-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00;
                border-color: #00ff00;
            }
            100% {
                box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000;
                border-color: #ff0000;
            }
        }

        /* ‰øÆÊ≠£ÔºöÂ∞áÊ®ôÈ°åÊîπÁÇ∫ÈªëËâ≤Ôºå‰øùÁïôÂãïÁï´ÊïàÊûú */
        .victory-modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #000000 !important; /* Âº∑Âà∂‰ΩøÁî®ÈªëËâ≤ */
            font-size: 1.8rem;
            animation: victory-text-pulse 1.5s infinite alternate;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important; /* ÁôΩËâ≤Èô∞ÂΩ±Â¢ûÂä†ÂèØËÆÄÊÄß */
        }

        @keyframes victory-text-pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .victory-stats {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            border: 1px solid rgba(52, 152, 219, 0.3);
            backdrop-filter: blur(5px);
        }

        .victory-stat {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .victory-stat-label {
            color: #7f8c8d;
            font-weight: 600;
        }

        .victory-stat-value {
            color: #2c3e50;
            font-weight: bold;
        }

        .victory-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .victory-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .victory-new-game-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            width: 100%;
        }

        .victory-buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* ÈªûÊìäË®àÊôÇÂô®Ê∏¨Ë©¶ÂäüËÉΩ */
        .timer.test-mode {
            animation: timer-test-flash 0.5s infinite alternate;
        }
        
        @keyframes timer-test-flash {
            0% { color: var(--primary); }
            100% { color: #ff0000; }
        }

        @media (max-width: 480px) {
            .controls-top {
                gap: 4px;
                margin-top: 0;
                margin-bottom: 0;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 0.8rem;
            }
            
            .cell {
                font-size: 1.4rem;
            }
            
            .numpad-btn .num {
                font-size: 1.1rem;
            }
            
            .icon-btn {
                font-size: 1.3rem;
            }
            
            .stat-icon {
                font-size: 0.9rem;
            }
            
            .keypad {
                height: 45px;
            }
            
            .modal {
                padding: 20px;
                width: 280px;
            }
            
            /* ÊâãÊ©üÁâàÂãùÂà©Áï´Èù¢Â≠óÈ´îË™øÊï¥ */
            .victory-modal h2 {
                font-size: 1.23rem; /* ‰∏≠ÊñáÈ†êË®≠Â§ßÂ∞è */
                margin-bottom: 15px;
            }
            
            /* ÊâãÊ©üËã±ÊñáÊ®°ÂºèÂ≠óÈ´îË™øÊï¥ */
            .victory-modal.english-mode h2 {
                font-size: 0.98rem !important;
            }
            
            .victory-stats {
                padding: 15px;
                margin: 15px 0;
            }
            
            .victory-stat {
                font-size: 1rem;
                margin: 8px 0;
            }
            
            .pause-modal h2 {
                font-size: 1.5rem;
            }
            
            .pause-modal p {
                font-size: 0.9rem;
            }
            
            .pause-modal .modal-btn {
                font-size: 0.9rem;
            }
            
            .bible-modal {
                width: 95%;
                max-width: 95%;
                padding: 15px;
            }
            
            .bible-modal h2 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            
            .bible-content {
                font-size: 1rem;
                padding: 10px;
                line-height: 1.6;
            }
            
            .bible-verse {
                margin-bottom: 12px;
                padding-left: 2em;
                text-indent: -2em;
            }
            
            .verse-number {
                width: 2em;
            }
            
            .difficulty-select {
                font-size: 0.8rem;
                min-width: 90px;
                padding: 5px 8px;
            }
        }
        
        @media (min-width: 600px) {
            .victory-modal {
                min-width: 400px;
                padding: 40px;
            }
            
            .victory-modal h2 {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="controls-top">
            <select class="difficulty-select" id="difficulty">
                <option value="Beginner">ÂÖ•ÈñÄ</option>
                <option value="Easy" selected>Á∞°ÂñÆ</option>
                <option value="Medium">‰∏≠Á≠â</option>
                <option value="Hard">Âõ∞Èõ£</option>
                <option value="Expert">Â∞àÂÆ∂</option>
            </select>
            
            <button class="icon-btn" id="btn-new-game" title="Êñ∞ÈÅäÊà≤">üîÑ</button>
            <button class="icon-btn" id="btn-notes" title="Á≠ÜË®òÊ®°Âºè">üìù</button>
            <button class="icon-btn" id="btn-hint" title="ÊèêÁ§∫">üí°</button>
            <button class="icon-btn" id="btn-sound" title="Èü≥Êïà">üîä</button>
            <button class="icon-btn" id="btn-language" title="Ë™ûË®Ä">üåê</button>
            <button class="icon-btn" id="btn-theme" title="‰∏ªÈ°å">üåô</button>
        </div>
        
        <div class="status-bar">
            <div class="timer-container">
                <div class="timer" id="timer-display">00:00:00</div>
                <div class="pause-btn" id="pause-btn">‚è∏Ô∏è</div>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-icon error">‚ùå</div>
                    <span class="stat-value" id="error-stat">00</span>
                </div>
                <div class="stat-item">
                    <div class="stat-icon hint">üí°</div>
                    <span class="stat-value" id="hint-stat">00</span>
                </div>
            </div>
        </div>
        
        <div id="sudoku-board"></div>
        
        <div class="keypad" id="keypad"></div>
    </div>

    <!-- ÁÖôËä±ÂÆπÂô® -->
    <div id="fireworks-container"></div>

    <!-- ÂãùÂà©Áï´Èù¢ -->
    <div class="overlay" id="victory-overlay">
        <div class="modal victory-modal" id="victory-modal">
            <h2 id="victory-title">üéâ ÊÅ≠ÂñúÁ†¥ÈóúÔºÅ üéâ</h2>
            
            <div class="victory-stats">
                <div class="victory-stat">
                    <span class="victory-stat-label">ÈÅäÊà≤ÊôÇÈñì:</span>
                    <span class="victory-stat-value" id="victory-time">00:00:00</span>
                </div>
                <div class="victory-stat">
                    <span class="victory-stat-label">ÈåØË™§Ê¨°Êï∏:</span>
                    <span class="victory-stat-value" id="victory-errors">00</span>
                </div>
                <div class="victory-stat">
                    <span class="victory-stat-label">ÊèêÁ§∫Ê¨°Êï∏:</span>
                    <span class="victory-stat-value" id="victory-hints">00</span>
                </div>
            </div>
            
            <div class="victory-buttons">
                <button class="victory-new-game-btn" onclick="closeOverlay()" id="victory-ok-btn">Êñ∞ÈÅäÊà≤</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="pause-overlay">
        <div class="modal pause-modal">
            <h2 id="pause-title">ÈÅäÊà≤Êö´ÂÅú</h2>
            <p id="pause-text">ÈªûÊìäÊåâÈàïÁπºÁ∫å</p>
            <button class="modal-btn" id="resume-btn">ÁπºÁ∫å</button>
        </div>
    </div>

    <div class="overlay" id="bible-overlay">
        <div class="modal bible-modal">
            <h2 id="bible-title">Ë©©ÁØá 23ÁØá</h2>
            <div class="bible-content" id="bible-content"></div>
            <button class="modal-btn" id="close-bible-btn">ÈóúÈñâ</button>
        </div>
    </div>

    <script>
        // ========== ÈÅäÊà≤Ê†∏ÂøÉËÆäÊï∏ - ‰øùÊåÅ‰∏çËÆä ==========
        let board = [];
        let solution = [];
        let initial = [];
        let selectedCell = null;
        let notesEnabled = false;
        let soundEnabled = true;
        let gameOver = false;
        let isPaused = false;
        let counts = Array(10).fill(9);
        let timerInterval = null;
        let timeElapsed = 0;
        let errorCount = 0;
        let hintCount = 0;
        let secretCode = [8,5,8,9,3,8,6,1];
        let inputSequence = [];
        let lastInputTime = 0;
        let isFreshGame = true;
        let fireworksInterval = null;
        let fireworksActive = false;
        let currentLanguage = 'zh-TW';
        let currentTheme = 'light';
        
        // Ê∏¨Ë©¶Ê®°ÂºèËÆäÊï∏
        let timerClickCount = 0;
        let timerClickStartTime = 0;
        const TIMER_CLICK_THRESHOLD = 3; // ÈªûÊìä3Ê¨°
        const TIMER_CLICK_TIMEOUT = 1500; // 1.5ÁßíÂÖß
        
        const translations = {
            'zh-TW': {
                difficulty: {
                    'Beginner': 'ÂÖ•ÈñÄ',
                    'Easy': 'Á∞°ÂñÆ',
                    'Medium': '‰∏≠Á≠â',
                    'Hard': 'Âõ∞Èõ£',
                    'Expert': 'Â∞àÂÆ∂'
                },
                victoryTitle: 'üéâ ÊÅ≠ÂñúÁ†¥ÈóúÔºÅ üéâ',
                victoryTime: 'ÈÅäÊà≤ÊôÇÈñì',
                victoryErrors: 'ÈåØË™§Ê¨°Êï∏',
                victoryHints: 'ÊèêÁ§∫Ê¨°Êï∏',
                victoryOK: 'Êñ∞ÈÅäÊà≤',
                pauseTitle: 'ÈÅäÊà≤Êö´ÂÅú',
                pauseText: 'ÈªûÊìäÊåâÈàïÁπºÁ∫å',
                resume: 'ÁπºÁ∫å',
                bibleTitle: 'Ë©©ÁØá 23ÁØá',
                closeBible: 'ÈóúÈñâ',
                newGame: 'Êñ∞ÈÅäÊà≤',
                notesMode: 'Á≠ÜË®òÊ®°Âºè',
                hint: 'ÊèêÁ§∫',
                sound: 'Èü≥Êïà',
                language: 'Ë™ûË®Ä',
                theme: '‰∏ªÈ°å'
            },
            'zh-CN': {
                difficulty: {
                    'Beginner': 'ÂÖ•Èó®',
                    'Easy': 'ÁÆÄÂçï',
                    'Medium': '‰∏≠Á≠â',
                    'Hard': 'Âõ∞Èöæ',
                    'Expert': '‰∏ìÂÆ∂'
                },
                victoryTitle: 'üéâ ÊÅ≠ÂñúÁ†¥ÂÖ≥ÔºÅ üéâ',
                victoryTime: 'Ê∏∏ÊàèÊó∂Èó¥',
                victoryErrors: 'ÈîôËØØÊ¨°Êï∞',
                victoryHints: 'ÊèêÁ§∫Ê¨°Êï∞',
                victoryOK: 'Êñ∞Ê∏∏Êàè',
                pauseTitle: 'Ê∏∏ÊàèÊöÇÂÅú',
                pauseText: 'ÁÇπÂáªÊåâÈíÆÁªßÁª≠',
                resume: 'ÁªßÁª≠',
                bibleTitle: 'ËØóÁØá 23ÁØá',
                closeBible: 'ÂÖ≥Èó≠',
                newGame: 'Êñ∞Ê∏∏Êàè',
                notesMode: 'Á¨îËÆ∞Ê®°Âºè',
                hint: 'ÊèêÁ§∫',
                sound: 'Èü≥Êïà',
                language: 'ËØ≠Ë®Ä',
                theme: '‰∏ªÈ¢ò'
            },
            'en': {
                difficulty: {
                    'Beginner': 'Beginner',
                    'Easy': 'Easy',
                    'Medium': 'Medium',
                    'Hard': 'Hard',
                    'Expert': 'Expert'
                },
                victoryTitle: 'üéâ Congratulations! üéâ',
                victoryTime: 'Time',
                victoryErrors: 'Errors',
                victoryHints: 'Hints',
                victoryOK: 'New Game',
                pauseTitle: 'Game Paused',
                pauseText: 'Click the button to continue',
                resume: 'Resume',
                bibleTitle: 'Psalm 23',
                closeBible: 'Close',
                newGame: 'New Game',
                notesMode: 'Notes Mode',
                hint: 'Hint',
                sound: 'Sound',
                language: 'Language',
                theme: 'Theme'
            }
        };

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        // ========== Èü≥ÊïàÁ≥ªÁµ± - ‰øùÊåÅ‰∏çËÆä ==========
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
        }

        function playSound(type) {
            if (!soundEnabled) return;
            
            if (!audioCtx) initAudio();
            
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const now = audioCtx.currentTime;
            
            switch (type) {
                case 'correct':
                    const oscCorrect = audioCtx.createOscillator();
                    const gainNodeCorrect = audioCtx.createGain();
                    oscCorrect.connect(gainNodeCorrect);
                    gainNodeCorrect.connect(audioCtx.destination);
                    
                    oscCorrect.type = 'sine';
                    oscCorrect.frequency.setValueAtTime(1000, now);
                    gainNodeCorrect.gain.setValueAtTime(0.3, now);
                    gainNodeCorrect.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    oscCorrect.start(now);
                    oscCorrect.stop(now + 0.1);
                    break;
                    
                case 'error':
                    const oscError = audioCtx.createOscillator();
                    const gainNodeError = audioCtx.createGain();
                    oscError.connect(gainNodeError);
                    gainNodeError.connect(audioCtx.destination);
                    
                    oscError.type = 'sawtooth';
                    oscError.frequency.setValueAtTime(150, now);
                    oscError.frequency.linearRampToValueAtTime(100, now + 0.3);
                    gainNodeError.gain.setValueAtTime(0.2, now);
                    gainNodeError.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    oscError.start(now);
                    oscError.stop(now + 0.3);
                    break;
                    
                case 'hint':
                    const oscHint = audioCtx.createOscillator();
                    const gainNodeHint = audioCtx.createGain();
                    oscHint.connect(gainNodeHint);
                    gainNodeHint.connect(audioCtx.destination);
                    
                    oscHint.type = 'triangle';
                    oscHint.frequency.setValueAtTime(300, now);
                    oscHint.frequency.linearRampToValueAtTime(800, now + 0.3);
                    gainNodeHint.gain.setValueAtTime(0.1, now);
                    gainNodeHint.gain.linearRampToValueAtTime(0, now + 0.3);
                    oscHint.start(now);
                    oscHint.stop(now + 0.3);
                    break;
                    
                case 'ui':
                    const oscUI = audioCtx.createOscillator();
                    const gainNodeUI = audioCtx.createGain();
                    oscUI.connect(gainNodeUI);
                    gainNodeUI.connect(audioCtx.destination);
                    
                    oscUI.type = 'square';
                    oscUI.frequency.setValueAtTime(800, now);
                    gainNodeUI.gain.setValueAtTime(0.05, now);
                    gainNodeUI.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    oscUI.start(now);
                    oscUI.stop(now + 0.05);
                    break;
                    
                case 'win':
                    playHappySound(now);
                    break;
            }
        }

        function playHappySound(startTime) {
            if (!audioCtx) initAudio();
            
            const melody = [
                523.25, 587.33, 659.25, 698.46, 783.99, 880.00, 987.77, 1046.50,
                987.77, 880.00, 783.99, 698.46, 659.25, 587.33, 523.25
            ];
            
            melody.forEach((freq, index) => {
                const noteTime = startTime + index * 0.1;
                playNote(freq, noteTime, 0.08);
            });
        }

        function playNote(frequency, time, duration) {
            if (!audioCtx) initAudio();
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, time);
            
            gainNode.gain.setValueAtTime(0.1, time);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration);
            
            oscillator.start(time);
            oscillator.stop(time + duration);
        }

        // ========== È†ÅÈù¢ÂàùÂßãÂåñ - ‰øùÊåÅ‰∏çËÆä ==========
        document.addEventListener('DOMContentLoaded', () => {
            createBoardHTML();
            createKeypadHTML();
            startNewGame();
            setupEventListeners();
            loadBibleContent();
            updateUIForLanguage();
        });

        function setupEventListeners() {
            document.getElementById('btn-new-game').addEventListener('click', () => {
                playSound('ui');
                startNewGame();
            });
            
            document.getElementById('btn-notes').addEventListener('click', () => {
                playSound('ui');
                toggleNotes();
            });
            
            document.getElementById('btn-hint').addEventListener('click', () => {
                useHint();
            });
            
            document.getElementById('btn-sound').addEventListener('click', () => {
                playSound('ui');
                toggleSound();
            });
            
            document.getElementById('btn-language').addEventListener('click', () => {
                playSound('ui');
                toggleLanguage();
            });
            
            document.getElementById('btn-theme').addEventListener('click', () => {
                playSound('ui');
                toggleTheme();
            });
            
            document.getElementById('difficulty').addEventListener('change', () => {
                playSound('ui');
                startNewGame();
            });
            
            document.getElementById('pause-btn').addEventListener('click', () => {
                togglePause();
            });
            
            document.getElementById('resume-btn').addEventListener('click', () => {
                togglePause();
            });
            
            document.getElementById('close-bible-btn').addEventListener('click', () => {
                closeBibleOverlay();
            });
            
            // Ê∑ªÂä†Ë®àÊôÇÂô®ÈªûÊìä‰∫ã‰ª∂ÔºàÊ∏¨Ë©¶ÂäüËÉΩÔºâ
            document.getElementById('timer-display').addEventListener('click', handleTimerClick);
        }

        // ========== ÈÅäÊà≤Ê†∏ÂøÉÂäüËÉΩ - ‰øùÊåÅ‰∏çËÆä ==========
        // ËôïÁêÜË®àÊôÇÂô®ÈªûÊìäÔºàÊ∏¨Ë©¶ÂäüËÉΩÔºâ
        function handleTimerClick() {
            const currentTime = Date.now();
            
            // ÈáçÁΩÆÈªûÊìäË®àÊï∏
            if (currentTime - timerClickStartTime > TIMER_CLICK_TIMEOUT) {
                timerClickCount = 1;
                timerClickStartTime = currentTime;
                document.getElementById('timer-display').classList.add('test-mode');
            } else {
                timerClickCount++;
            }
            
            // Â¶ÇÊûúÈªûÊìäÊ¨°Êï∏ÈÅîÂà∞ÈñæÂÄº
            if (timerClickCount >= TIMER_CLICK_THRESHOLD) {
                // Ëß∏ÁôºÊ∏¨Ë©¶ÂãùÂà©
                triggerTestVictory();
                timerClickCount = 0;
                document.getElementById('timer-display').classList.remove('test-mode');
            }
            
            // 2ÁßíÂæåÁßªÈô§Ê∏¨Ë©¶Ê®°ÂºèÊ®£Âºè
            setTimeout(() => {
                document.getElementById('timer-display').classList.remove('test-mode');
            }, 2000);
        }

        // Ëß∏ÁôºÊ∏¨Ë©¶ÂãùÂà©
        function triggerTestVictory() {
            if (gameOver) return;
            
            // Â∞áÊâÄÊúâÂñÆÂÖÉÊ†ºË®≠ÁΩÆÁÇ∫Ê≠£Á¢∫Á≠îÊ°à
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    board[r][c] = solution[r][c];
                }
            }
            
            updateBoardUI();
            updateCounts();
            checkWin();
        }

        function toggleLanguage() {
            if (currentLanguage === 'zh-TW') {
                currentLanguage = 'zh-CN';
            } else if (currentLanguage === 'zh-CN') {
                currentLanguage = 'en';
            } else {
                currentLanguage = 'zh-TW';
            }
            
            updateUIForLanguage();
        }

        function updateUIForLanguage() {
            const t = translations[currentLanguage];
            
            const difficultySelect = document.getElementById('difficulty');
            difficultySelect.innerHTML = '';
            
            const difficulties = ['Beginner', 'Easy', 'Medium', 'Hard', 'Expert'];
            difficulties.forEach(diff => {
                const option = document.createElement('option');
                option.value = diff;
                option.textContent = t.difficulty[diff];
                difficultySelect.appendChild(option);
            });
            
            difficultySelect.value = 'Easy';
            
            document.getElementById('victory-title').textContent = t.victoryTitle;
            document.getElementById('victory-ok-btn').textContent = t.victoryOK;
            
            document.getElementById('pause-title').textContent = t.pauseTitle;
            document.getElementById('pause-text').textContent = t.pauseText;
            document.getElementById('resume-btn').textContent = t.resume;
            
            document.getElementById('bible-title').textContent = t.bibleTitle;
            document.getElementById('close-bible-btn').textContent = t.closeBible;
            
            document.getElementById('btn-new-game').title = t.newGame;
            document.getElementById('btn-notes').title = t.notesMode;
            document.getElementById('btn-hint').title = t.hint;
            document.getElementById('btn-sound').title = t.sound;
            document.getElementById('btn-language').title = t.language;
            document.getElementById('btn-theme').title = t.theme;
            
            // Êõ¥Êñ∞ÂãùÂà©Áï´Èù¢Â≠óÈ´îÂ§ßÂ∞è
            const victoryModal = document.getElementById('victory-modal');
            if (currentLanguage === 'en') {
                victoryModal.classList.add('english-mode');
            } else {
                victoryModal.classList.remove('english-mode');
            }
            
            updateStats();
        }

        function toggleTheme() {
            if (currentTheme === 'light') {
                currentTheme = 'dark';
                document.body.classList.add('dark-theme');
                document.getElementById('btn-theme').innerHTML = '‚òÄÔ∏è';
                document.getElementById('btn-theme').title = '‰∫ÆËâ≤‰∏ªÈ°å';
            } else {
                currentTheme = 'light';
                document.body.classList.remove('dark-theme');
                document.getElementById('btn-theme').innerHTML = 'üåô';
                document.getElementById('btn-theme').title = 'ÊöóËâ≤‰∏ªÈ°å';
            }
            
            updateBoardBorders();
        }

        function updateBoardBorders() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.classList.remove('border-right', 'border-bottom');
                
                const r = parseInt(cell.dataset.r);
                const c = parseInt(cell.dataset.c);
                
                if ((c + 1) % 3 === 0 && c !== 8) cell.classList.add('border-right');
                if ((r + 1) % 3 === 0 && r !== 8) cell.classList.add('border-bottom');
            });
        }

        function startNewGame() {
            stopFireworks();
            
            if (isPaused) togglePause();
            
            const diff = document.getElementById('difficulty').value;
            
            generateSudoku(diff);
            
            gameOver = false;
            selectedCell = null;
            errorCount = 0;
            hintCount = 0;
            
            inputSequence = [];
            lastInputTime = 0;
            isFreshGame = true;
            
            // ÈáçÁΩÆÊ∏¨Ë©¶ÈªûÊìäË®àÊï∏
            timerClickCount = 0;
            document.getElementById('timer-display').classList.remove('test-mode');
            
            updateStats();
            updateBoardUI();
            updateCounts();
            updateHighlighting();
            
            startTimer();
        }

        function createBoardHTML() {
            const boardEl = document.getElementById('sudoku-board');
            boardEl.innerHTML = '';
            
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    
                    if ((c + 1) % 3 === 0 && c !== 8) cell.classList.add('border-right');
                    if ((r + 1) % 3 === 0 && r !== 8) cell.classList.add('border-bottom');
                    
                    const notesDiv = document.createElement('div');
                    notesDiv.className = 'notes-grid';
                    for(let i = 1; i <= 9; i++) {
                        const note = document.createElement('div');
                        note.className = 'note-num';
                        note.dataset.num = i;
                        notesDiv.appendChild(note);
                    }
                    cell.appendChild(notesDiv);
                    
                    const numSpan = document.createElement('span');
                    numSpan.className = 'main-num';
                    cell.appendChild(numSpan);
                    
                    cell.addEventListener('click', () => selectCell(r, c));
                    boardEl.appendChild(cell);
                }
            }
        }

        function createKeypadHTML() {
            const keypad = document.getElementById('keypad');
            keypad.innerHTML = '';
            
            for (let i = 1; i <= 9; i++) {
                const btn = document.createElement('div');
                btn.className = 'numpad-btn';
                btn.id = `btn-num-${i}`;
                btn.innerHTML = `<div class="num">${i}</div><div class="count">9</div>`;
                btn.addEventListener('click', () => handleInput(i));
                keypad.appendChild(btn);
            }
        }

        function selectCell(r, c) {
            if (gameOver || isPaused) return;
            
            selectedCell = { r, c };
            
            updateHighlighting();
            
            playSound('ui');
        }

        function handleInput(num) {
            if (gameOver || isPaused) return;
            
            checkSecretCode(num);
            
            if (!selectedCell) return;
            
            const { r, c } = selectedCell;
            
            if (initial[r][c] !== 0 || (board[r][c] !== 0 && board[r][c] === solution[r][c])) return;
            
            const cellDiv = getCellDiv(r, c);
            
            if (num === solution[r][c]) {
                board[r][c] = num;
                playSound('correct');
                updateBoardUI();
                updateCounts();
                updateHighlighting();
                checkWin();
                
                isFreshGame = false;
            } else {
                playSound('error');
                errorCount++;
                updateStats();
                
                cellDiv.querySelector('.main-num').innerText = num;
                cellDiv.classList.add('error');
                cellDiv.classList.add('filled');
                
                setTimeout(() => {
                    cellDiv.classList.remove('error');
                    cellDiv.querySelector('.main-num').innerText = board[r][c] === 0 ? '' : board[r][c];
                    cellDiv.classList.remove('filled');
                    if (notesEnabled) updateNotes();
                }, 500);
                
                isFreshGame = false;
            }
        }

        function checkSecretCode(num) {
            if (!isFreshGame) return;
            
            const currentTime = Date.now();
            
            if (currentTime - lastInputTime > 3000) {
                inputSequence = [];
            }
            
            inputSequence.push(num);
            lastInputTime = currentTime;
            
            if (inputSequence.length > secretCode.length) {
                inputSequence.shift();
            }
            
            if (inputSequence.length === secretCode.length) {
                let isMatch = true;
                
                for (let i = 0; i < secretCode.length; i++) {
                    if (inputSequence[i] !== secretCode[i]) {
                        isMatch = false;
                        break;
                    }
                }
                
                if (isMatch) {
                    showBibleOverlay();
                    inputSequence = [];
                    isFreshGame = false;
                }
            }
        }

        function showBibleOverlay() {
            document.getElementById('bible-overlay').style.display = 'flex';
            playSound('ui');
        }

        function closeBibleOverlay() {
            document.getElementById('bible-overlay').style.display = 'none';
            playSound('ui');
        }

        function loadBibleContent() {
            const bibleContent = document.getElementById('bible-content');
            
            const psalms23 = [
                { number: 1, text: "ËÄ∂ÂíåËèØÊòØÊàëÁöÑÁâßËÄÖÔºåÊàëÂøÖ‰∏çËá¥Áº∫‰πè„ÄÇ" },
                { number: 2, text: "‰ªñ‰ΩøÊàëË∫∫Ëá•Âú®ÈùíËçâÂú∞‰∏äÔºåÈ†òÊàëÂú®ÂèØÂÆâÊ≠áÁöÑÊ∞¥ÈÇä„ÄÇ" },
                { number: 3, text: "‰ªñ‰ΩøÊàëÁöÑÈùàÈ≠ÇÁî¶ÈÜíÔºåÁÇ∫Ëá™Â∑±ÁöÑÂêçÂºïÂ∞éÊàëËµ∞Áæ©Ë∑Ø„ÄÇ" },
                { number: 4, text: "ÊàëÈõñÁÑ∂Ë°åÈÅéÊ≠ªËî≠ÁöÑÂπΩË∞∑Ôºå‰πü‰∏çÊÄïÈÅ≠ÂÆ≥ÔºåÂõ†ÁÇ∫‰Ω†ËàáÊàëÂêåÂú®Ôºõ‰Ω†ÁöÑÊùñÔºå‰Ω†ÁöÑÁ´øÔºåÈÉΩÂÆâÊÖ∞Êàë„ÄÇ" },
                { number: 5, text: "Âú®ÊàëÊïµ‰∫∫Èù¢ÂâçÔºå‰Ω†ÁÇ∫ÊàëÊì∫Ë®≠Á≠µÂ∏≠Ôºõ‰Ω†Áî®Ê≤πËÜè‰∫ÜÊàëÁöÑÈ†≠Ôºå‰ΩøÊàëÁöÑÁ¶èÊùØÊªøÊ∫¢„ÄÇ" },
                { number: 6, text: "Êàë‰∏ÄÁîü‰∏Ä‰∏ñÂøÖÊúâÊÅ©ÊÉ†ÊÖàÊÑõÈö®ËëóÊàëÔºõÊàë‰∏îË¶Å‰ΩèÂú®ËÄ∂ÂíåËèØÁöÑÊÆø‰∏≠ÔºåÁõ¥Âà∞Ê∞∏ÈÅ†„ÄÇ" }
            ];
            
            bibleContent.innerHTML = '';
            
            psalms23.forEach(verse => {
                const verseElement = document.createElement('div');
                verseElement.className = 'bible-verse';
                
                const verseNumber = document.createElement('span');
                verseNumber.className = 'verse-number';
                verseNumber.textContent = verse.number + '.';
                
                const verseText = document.createElement('span');
                verseText.textContent = verse.text;
                
                verseElement.appendChild(verseNumber);
                verseElement.appendChild(verseText);
                
                bibleContent.appendChild(verseElement);
            });
        }

        function updateStats() {
            const t = translations[currentLanguage];
            
            document.getElementById('error-stat').innerText = errorCount.toString().padStart(2, '0');
            document.getElementById('hint-stat').innerText = hintCount.toString().padStart(2, '0');
            
            document.getElementById('victory-errors').innerText = errorCount.toString().padStart(2, '0');
            document.getElementById('victory-hints').innerText = hintCount.toString().padStart(2, '0');
            
            const victoryStats = document.querySelector('.victory-stats');
            const victoryStatLabels = victoryStats.querySelectorAll('.victory-stat-label');
            if (victoryStatLabels.length >= 3) {
                victoryStatLabels[0].textContent = t.victoryTime + ':';
                victoryStatLabels[1].textContent = t.victoryErrors + ':';
                victoryStatLabels[2].textContent = t.victoryHints + ':';
            }
        }

        function startTimer() {
            stopTimer();
            timeElapsed = 0;
            isPaused = false;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                if (!isPaused && !gameOver) {
                    timeElapsed++;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const t = translations[currentLanguage];
            const hours = Math.floor(timeElapsed / 3600);
            const minutes = Math.floor((timeElapsed % 3600) / 60);
            const seconds = timeElapsed % 60;
            const text = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timer-display').innerText = text;
            document.getElementById('victory-time').innerText = text;
            return text;
        }

        function togglePause() {
            isPaused = !isPaused;
            
            if (isPaused) {
                document.getElementById('pause-overlay').style.display = 'flex';
                document.getElementById('sudoku-board').classList.add('blurred');
                playSound('ui');
            } else {
                document.getElementById('pause-overlay').style.display = 'none';
                document.getElementById('sudoku-board').classList.remove('blurred');
                playSound('ui');
            }
        }

        function generateSudoku(difficulty) {
            board = Array.from({ length: 9 }, () => Array(9).fill(0));
            
            fillDiagonal();
            
            solveSudoku(board);
            
            solution = JSON.parse(JSON.stringify(board));
            
            let attempts = 0;
            switch(difficulty) {
                case 'Beginner': attempts = 20; break;
                case 'Easy': attempts = 30; break;
                case 'Medium': attempts = 40; break;
                case 'Hard': attempts = 50; break;
                case 'Expert': attempts = 58; break;
            }
            
            initial = JSON.parse(JSON.stringify(solution));
            
            board = Array.from({ length: 9 }, () => Array(9).fill(0));
            
            let removed = 0;
            while (removed < attempts) {
                let row = Math.floor(Math.random() * 9);
                let col = Math.floor(Math.random() * 9);
                
                if (initial[row][col] !== 0) {
                    initial[row][col] = 0;
                    removed++;
                }
            }
        }

        function fillDiagonal() {
            for (let i = 0; i < 9; i += 3) {
                fillBox(i, i);
            }
        }

        function fillBox(row, col) {
            let num;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    do {
                        num = Math.floor(Math.random() * 9) + 1;
                    } while (!isSafeInBox(row, col, num));
                    
                    board[row + i][col + j] = num;
                }
            }
        }

        function isSafeInBox(rowStart, colStart, num) {
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[rowStart + i][colStart + j] === num) return false;
                }
            }
            return true;
        }

        function solveSudoku(grid) {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (grid[row][col] === 0) {
                        for (let num = 1; num <= 9; num++) {
                            if (isSafe(grid, row, col, num)) {
                                grid[row][col] = num;
                                
                                if (solveSudoku(grid)) return true;
                                
                                grid[row][col] = 0;
                            }
                        }
                        return false;
                    }
                }
            }
            return true;
        }

        function isSafe(grid, row, col, num) {
            for (let x = 0; x < 9; x++) {
                if (grid[row][x] === num) return false;
            }
            
            for (let x = 0; x < 9; x++) {
                if (grid[x][col] === num) return false;
            }
            
            let startRow = row - row % 3;
            let startCol = col - col % 3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (grid[i + startRow][j + startCol] === num) return false;
                }
            }
            return true;
        }

        function useHint() {
            if (gameOver || isPaused) return;
            
            const emptyCells = [];
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] === 0 && initial[r][c] === 0) {
                        emptyCells.push({r, c});
                    }
                }
            }
            
            if (emptyCells.length === 0) return;
            
            hintCount++;
            updateStats();
            
            const { r, c } = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            const correctNum = solution[r][c];
            
            board[r][c] = correctNum;
            updateBoardUI();
            
            const cellDiv = getCellDiv(r, c);
            cellDiv.classList.add('hinting');
            setTimeout(() => {
                if (cellDiv) cellDiv.classList.remove('hinting');
            }, 2000);
            
            playSound('hint');
            
            updateCounts();
            updateHighlighting();
            
            checkWin();
            
            isFreshGame = false;
        }

        function getCellDiv(r, c) {
            return document.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
        }

        function updateBoardUI() {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = getCellDiv(r, c);
                    
                    const val = board[r][c] !== 0 ? board[r][c] : initial[r][c];
                    
                    cell.querySelector('.main-num').innerText = val === 0 ? '' : val;
                    
                    cell.className = 'cell';
                    
                    if ((c + 1) % 3 === 0 && c !== 8) cell.classList.add('border-right');
                    if ((r + 1) % 3 === 0 && r !== 8) cell.classList.add('border-bottom');
                    
                    if (initial[r][c] !== 0) {
                        cell.classList.add('clue');
                    } else if (board[r][c] !== 0) {
                        cell.classList.add('filled');
                    }
                }
            }
            
            if (notesEnabled) updateNotes();
            else clearNotes();
        }

        function toggleNotes() {
            if (isPaused) return;
            
            notesEnabled = !notesEnabled;
            
            const notesBtn = document.getElementById('btn-notes');
            if (notesEnabled) {
                notesBtn.classList.add('btn-on');
                notesBtn.classList.remove('btn-secondary');
            } else {
                notesBtn.classList.remove('btn-on');
                notesBtn.classList.add('btn-secondary');
            }
            
            if (notesEnabled) updateNotes();
            else clearNotes();
            
            updateHighlighting();
        }

        function clearNotes() {
            document.querySelectorAll('.note-num').forEach(el => el.innerText = '');
        }

        function updateNotes() {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = getCellDiv(r, c);
                    const noteContainer = cell.querySelector('.notes-grid');
                    
                    noteContainer.querySelectorAll('.note-num').forEach(n => n.innerText = '');
                    
                    if (board[r][c] === 0 && initial[r][c] === 0) {
                        let combinedGrid = JSON.parse(JSON.stringify(initial));
                        for (let i = 0; i < 9; i++) {
                            for (let j = 0; j < 9; j++) {
                                if (board[i][j] !== 0) combinedGrid[i][j] = board[i][j];
                            }
                        }
                        
                        for (let n = 1; n <= 9; n++) {
                            if (isSafe(combinedGrid, r, c, n)) {
                                noteContainer.querySelector(`.note-num[data-num='${n}']`).innerText = n;
                            }
                        }
                    }
                }
            }
        }

        function updateHighlighting() {
            document.querySelectorAll('.cell').forEach(c => {
                c.classList.remove('selected', 'highlight-related', 'highlight-same');
            });
            
            document.querySelectorAll('.note-num').forEach(n => {
                n.classList.remove('highlighted');
            });
            
            document.querySelectorAll('.numpad-btn').forEach(b => {
                b.classList.remove('suggested');
            });
            
            if (!selectedCell) return;
            
            const { r, c } = selectedCell;
            
            const val = board[r][c] !== 0 ? board[r][c] : initial[r][c];
            
            const startRow = r - r % 3;
            const startCol = c - c % 3;
            
            for (let i = 0; i < 9; i++) {
                getCellDiv(r, i).classList.add('highlight-related');
                getCellDiv(i, c).classList.add('highlight-related');
            }
            
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    getCellDiv(startRow + i, startCol + j).classList.add('highlight-related');
                }
            }
            
            getCellDiv(r, c).classList.add('selected');
            
            if (val !== 0) {
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        const cellVal = board[i][j] !== 0 ? board[i][j] : initial[i][j];
                        if (cellVal === val) {
                            getCellDiv(i, j).classList.add('highlight-same');
                        }
                    }
                }
                
                if (notesEnabled) {
                    document.querySelectorAll(`.note-num[data-num='${val}']`).forEach(noteEl => {
                        if (noteEl.innerText === String(val)) {
                            noteEl.classList.add('highlighted');
                        }
                    });
                }
            }
            
            if (board[r][c] === 0 && initial[r][c] === 0) {
                checkGroupAndHighlight(r, c);
            }
        }

        function checkGroupAndHighlight(r, c) {
            let rowValues = [];
            for (let i = 0; i < 9; i++) {
                const val = board[r][i] !== 0 ? board[r][i] : initial[r][i];
                rowValues.push(val);
            }
            let rowMissing = findMissingNumber(rowValues);
            if (rowMissing !== -1) {
                highlightSuggestedNumber(rowMissing);
                return;
            }
            
            let colValues = [];
            for (let i = 0; i < 9; i++) {
                const val = board[i][c] !== 0 ? board[i][c] : initial[i][c];
                colValues.push(val);
            }
            let colMissing = findMissingNumber(colValues);
            if (colMissing !== -1) {
                highlightSuggestedNumber(colMissing);
                return;
            }
            
            let boxValues = [];
            const startRow = r - r % 3;
            const startCol = c - c % 3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const val = board[startRow + i][startCol + j] !== 0 ? 
                                board[startRow + i][startCol + j] : 
                                initial[startRow + i][startCol + j];
                    boxValues.push(val);
                }
            }
            let boxMissing = findMissingNumber(boxValues);
            if (boxMissing !== -1) {
                highlightSuggestedNumber(boxMissing);
                return;
            }
        }

        function findMissingNumber(values) {
            let missing = 0;
            let count = 0;
            for (let i = 1; i <= 9; i++) {
                if (!values.includes(i)) {
                    missing = i;
                    count++;
                }
            }
            return count === 1 ? missing : -1;
        }

        function highlightSuggestedNumber(num) {
            const btn = document.getElementById(`btn-num-${num}`);
            if (btn) {
                btn.classList.add('suggested');
            }
        }

        function updateCounts() {
            counts.fill(9);
            
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const val = board[r][c] !== 0 ? board[r][c] : initial[r][c];
                    if (val !== 0) counts[val]--;
                }
            }
            
            for (let i = 1; i <= 9; i++) {
                const btn = document.getElementById(`btn-num-${i}`);
                btn.querySelector('.count').innerText = counts[i];
                
                if (counts[i] <= 0) {
                    btn.classList.add('faded');
                } else {
                    btn.classList.remove('faded');
                }
            }
        }

        function checkWin() {
            let isFull = true;
            
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cellVal = board[r][c] !== 0 ? board[r][c] : initial[r][c];
                    if (cellVal !== solution[r][c]) {
                        isFull = false;
                        break;
                    }
                }
                if (!isFull) break;
            }
            
            if (isFull) {
                gameOver = true;
                stopTimer();
                playSound('win');
                
                document.getElementById('victory-time').innerText = updateTimerDisplay();
                document.getElementById('victory-errors').innerText = errorCount.toString().padStart(2, '0');
                document.getElementById('victory-hints').innerText = hintCount.toString().padStart(2, '0');
                
                showVictoryScreen();
                
                document.querySelectorAll('.cell').forEach(c => {
                    c.classList.remove('selected', 'highlight-related', 'highlight-same');
                });
            }
        }

        function showVictoryScreen() {
            document.getElementById('victory-overlay').style.display = 'flex';
            
            // Á¢∫‰øùÁÖôËä±ÊïàÊûúÊ≠£Â∏∏ÂïüÂãï
            startFireworks();
        }

        // ========== ÁÖôËä±ÊïàÊûúÁ≥ªÁµ± - Á¢∫‰øùÊ≠£Â∏∏ÈÅã‰Ωú ==========
        function startFireworks() {
            console.log("ÈñãÂßãÁÖôÁÅ´ÊïàÊûú");
            
            const container = document.getElementById('fireworks-container');
            if (!container) {
                console.error("Êâæ‰∏çÂà∞ÁÖôËä±ÂÆπÂô®!");
                return;
            }
            
            container.innerHTML = '';
            
            fireworksActive = true;
            
            const fireworkCount = 30;
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff6600', '#ff0099', '#ff1493', '#00ff7f', '#ff4500', '#da70d6'];
            
            let created = 0;
            fireworksInterval = setInterval(() => {
                if (created >= fireworkCount) {
                    clearInterval(fireworksInterval);
                    fireworksInterval = null;
                    return;
                }
                
                const x = Math.random() * window.innerWidth;
                const y = window.innerHeight + 50;
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                createFirework(x, y, color);
                
                created++;
            }, 150);
        }

        function createFirework(x, y, color) {
            const container = document.getElementById('fireworks-container');
            if (!container) return;
            
            const core = document.createElement('div');
            core.className = 'firework-particle';
            core.style.left = x + 'px';
            core.style.top = y + 'px';
            core.style.backgroundColor = color;
            core.style.width = '12px';
            core.style.height = '12px';
            core.style.boxShadow = `0 0 30px ${color}, 0 0 60px ${color}`;
            core.style.zIndex = '9999';
            container.appendChild(core);
            
            const riseDuration = 1200;
            const targetY = Math.random() * (window.innerHeight * 0.5) + (window.innerHeight * 0.2);
            
            let startTime = null;
            
            function riseAnimation(currentTime) {
                if (!startTime) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / riseDuration, 1);
                
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                
                const newY = y - (targetY - y) * easeOutCubic;
                core.style.top = newY + 'px';
                
                // Ë™øÊï¥Â§ßÂ∞èÂíåÈô∞ÂΩ±
                const size = 12 * (1 + easeOutCubic * 0.5);
                core.style.width = size + 'px';
                core.style.height = size + 'px';
                core.style.boxShadow = `0 0 ${30 + easeOutCubic * 30}px ${color}, 0 0 ${60 + easeOutCubic * 40}px ${color}`;
                
                if (progress < 1) {
                    requestAnimationFrame(riseAnimation);
                } else {
                    explodeFirework(x, newY, color);
                    if (core.parentNode) {
                        container.removeChild(core);
                    }
                }
            }
            
            requestAnimationFrame(riseAnimation);
        }

        function explodeFirework(x, y, color) {
            const container = document.getElementById('fireworks-container');
            if (!container) return;
            
            const particleCount = 150;
            const particles = [];
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.backgroundColor = color;
                particle.style.width = '10px';
                particle.style.height = '10px';
                particle.style.boxShadow = `0 0 25px ${color}, 0 0 50px ${color}`;
                particle.style.zIndex = '9999';
                particle.style.opacity = '1';
                container.appendChild(particle);
                
                const angle = (i / particleCount) * Math.PI * 2;
                const speed = 4 + Math.random() * 5;
                
                particles.push({
                    element: particle,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1.0,
                    decay: 0.006 + Math.random() * 0.015,
                    color: color
                });
            }
            
            function animateParticles() {
                if (!fireworksActive) {
                    particles.forEach(p => {
                        if (p.element.parentNode) {
                            container.removeChild(p.element);
                        }
                    });
                    return;
                }
                
                let allDead = true;
                
                particles.forEach(p => {
                    if (p.life <= 0) return;
                    
                    p.life -= p.decay;
                    
                    if (p.life > 0) {
                        allDead = false;
                        
                        const currentX = parseFloat(p.element.style.left);
                        const currentY = parseFloat(p.element.style.top);
                        
                        p.element.style.left = (currentX + p.vx) + 'px';
                        p.element.style.top = (currentY + p.vy) + 'px';
                        
                        // ÈáçÂäõÊïàÊûú
                        p.vy += 0.12;
                        
                        p.element.style.opacity = p.life;
                        
                        const size = 10 * p.life;
                        p.element.style.width = size + 'px';
                        p.element.style.height = size + 'px';
                        
                        // ÈñÉÁàçÊïàÊûú
                        if (Math.random() < 0.08) {
                            const glow = 25 + Math.random() * 20;
                            p.element.style.boxShadow = `0 0 ${glow}px ${p.color}, 0 0 ${glow * 2}px ${p.color}`;
                        }
                    } else {
                        if (p.element.parentNode) {
                            container.removeChild(p.element);
                        }
                    }
                });
                
                if (!allDead) {
                    requestAnimationFrame(animateParticles);
                }
            }
            
            requestAnimationFrame(animateParticles);
        }

        function stopFireworks() {
            fireworksActive = false;
            
            if (fireworksInterval) {
                clearInterval(fireworksInterval);
                fireworksInterval = null;
            }
            
            const container = document.getElementById('fireworks-container');
            if (container) {
                container.innerHTML = '';
            }
        }

        function closeOverlay() {
            document.getElementById('victory-overlay').style.display = 'none';
            stopFireworks();
            
            startNewGame();
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            
            const soundBtn = document.getElementById('btn-sound');
            if (soundEnabled) {
                soundBtn.innerHTML = 'üîä';
                soundBtn.title = 'Sound On';
            } else {
                soundBtn.innerHTML = 'üîá';
                soundBtn.title = 'Sound Off';
            }
        }
    </script>
</body>
</html>